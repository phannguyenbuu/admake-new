<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Leads</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">


    <style>
        table.table-striped.table-bordered tbody tr {
            max-height: 30px; /* gi·∫£m chi·ªÅu cao h√†ng */
        }
        table.table-striped.table-bordered tbody tr td,
        table.table-striped.table-bordered tbody tr th {
            padding-top: 0px;
            padding-bottom: 0px;
            vertical-align: middle;
        }
        table.table-striped.table-bordered tbody tr td p {
            margin: 0;
            font-size: 12px; /* gi·∫£m c·ª° ch·ªØ trong th·∫ª p */
        }
    </style>
</head>
<body>
  
    <div class="container-fluid" style="padding: 20px;background-color: #00B4B6;color:#fff">
      <a class="navbar-brand" href="#">ADMAKE ADMIN</a>
    </div>
  
  <div class="container mt-4">
    <h1 class="mb-4">Danh s√°ch kh√°ch h√†ng</h1>
            <table class="table table-striped table-bordered table-sm">
      <thead class="table-light" style="background-color: #00B4B6;">
        <tr>
          <th style="width: 30px;">
            Inv
          </th>
          <th style="width: 30px;">
            Act
          </th>
          <th>ID</th>
          <th style="width:200px">H·ªç v√† t√™n</th>
          <th style="width:200px">Username ({{total_users}})</th>
          <th style="width:200px">C√¥ng ty</th>
          
          <th>Li√™n h·ªá</th>
          <th style="width:200px">Nhu c·∫ßu</th>
          
          <!-- <th style="width:200px; font-size:10px">Quy m√¥ c√¥ng ty</th> -->
          <th style="width:100px">S·ªë d∆∞</th>
          <th style="width:200px; font-size:10px">Ng√†y ƒëƒÉng k√Ω/gia h·∫°n/h·∫øt h·∫°n</th>
          
        </tr>
      </thead>
      <tbody>
        {% for lead in leads %}
        <tr>
          <td>
            <input type="checkbox" name="selected_leads" value="{{ lead.id }}" {% if lead.isInvited %}checked{% endif %} />
          </td>
          <td>
            <input type="checkbox" name="activated_leads" value="{{ lead.id }}" {% if lead.isActivated %}checked{% endif %} />
          </td>
          <td>{{ lead.id }}</td>
          <td>{{ lead.name }}</td>

         <td>
          <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
              <!-- Hi·ªÉn th·ªã username ƒê√É G√ÅN - KH√îNG D√ôNG BREAK -->
              <!-- {% if lead.user_id_str %}
                  {% for user in users %}
                      {% if user.id|string == lead.user_id_str %}
                      <p style="font-size: 10px; margin: 0; color: #00B4B6; font-weight: bold;">
                          {{ user.username }}
                      </p>
                      {% endif %}
                  {% endfor %}
              {% endif %} -->
              
              <!-- DROPDOWN -->
              <select class="form-select form-select-sm" name="status-{{ lead.id }}"
                      id="select-{{ lead.id }}" data-lead-id="{{ lead.id }}">
                  <option value="">-- Ch·ªçn user --</option>
                  {% for user in users %}
                  <option value="{{ user.id }}" 
                          data-username="{{ user.username }}" 
                          data-password="{{ user.password }}"
                          {% if user.id|string == lead.user_id_str %}selected{% endif %}>
                      {{ user.username }}
                  </option>
                  {% endfor %}
              </select>
              
              <!-- ‚úÖ C·∫¢ 2 DISPLAY -->
              <!-- <p id="username-display-{{ lead.id }}" style="font-size: 10px; margin: 0;"></p> -->
              <p id="password-display-{{ lead.id }}" style="font-size: 10px; color:red; margin: 0;"></p>
          </div>
      </td>

          <td>
            <p>{{ lead.company }}</p>
            <p style="font-size:10px">{{ lead.companySize }}</p>
          </td>
          
          <td>
            <p>{{ lead.phone }}</p>
            <p style="font-size:10px;text-transform: lowercase;">{{ lead.email }}</p>
          </td>
          
          <td>
            <p>{{ lead.industry }}</p>
            <p style="font-size:10px">{{ lead.description }}</p>
          </td>
          
          <td>{{ lead.balance_amount }}</td>
          <td>
            <p>{{ lead.createdAt }}</p>
            <p>{{ lead.updatedAt }}</p>
            <p style="color:red; font-weight:700">{{ lead.expiredAt }}</p>
          </td>

          <!-- C·ªòT DROPDOWN -->
          <!-- TH·∫∫ DROPDOWN (thay th·∫ø ho√†n to√†n td dropdown c≈©) -->
          <!-- TH·∫∫ DROPDOWN (thay th·∫ø ho√†n to√†n td dropdown c≈©) -->
         <!-- C·ªòT DROPDOWN - THAY TH·∫æ HO√ÄN TO√ÄN -->
      






          
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Ph√¢n trang -->
    <nav aria-label="Page navigation example">
     <ul class="pagination justify-content-center">
      {% if page > 1 %}
       <li class="page-item">
        <a class="page-link" href="?page={{ page - 1 }}" aria-label="Previous">
         <span aria-hidden="true">&laquo;</span>
        </a>
       </li>
      {% endif %}

      {% for p in range(1, total_pages + 1) %}
            <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}">{{ p }}</a>
            </li>
            {% endfor %}


      {% if page < total_pages %}
       <li class="page-item">
        <a class="page-link" href="?page={{ page + 1 }}" aria-label="Next">
         <span aria-hidden="true">&raquo;</span>
        </a>
       </li>
      {% endif %}
     </ul>
    </nav>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // L·∫•y t·∫•t c·∫£ checkbox trong b·∫£ng
      const checkboxes = document.querySelectorAll("input[name='selected_leads']");

      checkboxes.forEach(chk => {
        chk.addEventListener('change', function() {
          const leadId = this.value;
          
          fetch(`https://admake.vn/api/lead/${leadId}/check`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              // N·∫øu c·∫ßn x√°c th·ª±c token bearer ho·∫∑c kh√°c th√¨ th√™m ·ªü ƒë√¢y
            },
            body: JSON.stringify({ isInvited: this.checked })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('L·ªói khi g·ª≠i d·ªØ li·ªáu');
            }
            return response.json();
          })
          .then(data => {
            console.log('Ph·∫£n h·ªìi t·ª´ server:', data);
            // C√≥ th·ªÉ th√™m th√¥ng b√°o th√†nh c√¥ng ho·∫∑c c·∫≠p nh·∫≠t UI
          })
          .catch(error => {
            console.error('L·ªói:', error);
            // C√≥ th·ªÉ th√¥ng b√°o l·ªói ng∆∞·ªùi d√πng
          });
        });
      });



      const ativatedCheckboxes = document.querySelectorAll("input[name='activated_leads']");

      ativatedCheckboxes.forEach(chk => {
        chk.addEventListener('change', function() {
          const leadId = this.value;
          
          fetch(`https://admake.vn/api/lead/${leadId}/activate`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              // N·∫øu c·∫ßn x√°c th·ª±c token bearer ho·∫∑c kh√°c th√¨ th√™m ·ªü ƒë√¢y
            },
            body: JSON.stringify({ isActivated: this.checked })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('L·ªói khi g·ª≠i d·ªØ li·ªáu');
            }
            return response.json();
          })
          .then(data => {
            console.log('Ph·∫£n h·ªìi t·ª´ server:', data);
            // C√≥ th·ªÉ th√™m th√¥ng b√°o th√†nh c√¥ng ho·∫∑c c·∫≠p nh·∫≠t UI
          })
          .catch(error => {
            console.error('L·ªói:', error);
            // C√≥ th·ªÉ th√¥ng b√°o l·ªói ng∆∞·ªùi d√πng
          });
        });
      });
    });
  </script>


  <script>
document.addEventListener('DOMContentLoaded', function() {
    const selects = document.querySelectorAll('select[id^="select-"]');
    
    selects.forEach(function(selectElem) {
        const leadId = selectElem.dataset.leadId;
        // const usernameDisplay = document.getElementById('username-display-' + leadId);
        const passwordDisplay = document.getElementById('password-display-' + leadId);
        
        // ‚úÖ CHECK C·∫¢ 2 DISPLAY T·ªíN T·∫†I
        if (!passwordDisplay) {
            console.warn('‚ùå Missing display elements for lead:', leadId);
            return;
        }
        
        // Load ban ƒë·∫ßu
        if (selectElem.value) {
            const selectedOption = selectElem.options[selectElem.selectedIndex];
            // usernameDisplay.textContent = selectedOption.getAttribute('data-username');
            passwordDisplay.textContent = selectedOption.getAttribute('data-password');
        }
        
        // ‚úÖ CHANGE ‚Üí L∆ØU + DEBUG LOG
        selectElem.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const userId = selectedOption.value;
            console.log('üîÑ CHANGE:', leadId, '‚Üí', userId);
            
            // usernameDisplay.textContent = selectedOption.getAttribute('data-username') || '';
            passwordDisplay.textContent = selectedOption.getAttribute('data-password') || '';
            
            fetch(`https://admake.vn/api/lead/${leadId}/assign-user`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId || null })
            })
            .then(response => {
                console.log('üì° Status:', response.status);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(data => console.log('‚úÖ L∆∞u OK:', data))
            .catch(error => {
                console.error('‚ùå L·ªói:', error);
                this.value = '';
                // usernameDisplay.textContent = '';
                passwordDisplay.textContent = '';
            });
        });
    });
});
</script>

</body>
</html>
