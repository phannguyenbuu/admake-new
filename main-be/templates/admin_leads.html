<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ labels.header_title or "Lead Management Dashboard" }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --ink-900: #111217;
      --ink-700: #2c2f3a;
      --ink-500: #5b6270;
      --paper: #f7f2ea;
      --accent: #0aa3a6;
      --accent-deep: #0b7f86;
      --card: #ffffff;
      --shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
    }

    body {
      font-family: "IBM Plex Sans", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: radial-gradient(circle at top left, #f3efe5 0%, #f7f2ea 45%, #f0f6f5 100%);
      color: var(--ink-900);
      min-height: 100vh;
    }

    .shell {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 220px;
      min-width: 220px;
      flex: 0 0 220px;
      background: linear-gradient(180deg, #111217 0%, #1b1d26 100%);
      color: #f8fafc;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      position: sticky;
      top: 0;
      height: 100vh;
    }

    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: "Space Grotesk", "Trebuchet MS", sans-serif;
    }

    .sidebar-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: linear-gradient(130deg, #0aa3a6, #0dc2b3);
      box-shadow: 0 0 0 6px rgba(13, 194, 179, 0.2);
    }

    .sidebar-title {
      font-size: 18px;
      letter-spacing: 1px;
    }

    .sidebar-subtitle {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: rgba(248, 250, 252, 0.6);
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sidebar-link {
      border: 1px solid rgba(248, 250, 252, 0.15);
      background: rgba(248, 250, 252, 0.08);
      color: #f8fafc;
      border-radius: 12px;
      padding: 10px 14px;
      text-align: left;
      font-weight: 500;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .sidebar-link:hover {
      background: rgba(248, 250, 252, 0.18);
    }

    .sidebar-link.is-active {
      background: linear-gradient(130deg, #0aa3a6, #0dc2b3);
      border-color: transparent;
      color: #0b1d1e;
      font-weight: 600;
    }

    .content {
      flex: 1 1 auto;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .topbar {
      background: linear-gradient(110deg, #0aa3a6, #0dc2b3 45%, #0e8a92 100%);
      color: #ffffff;
      padding: 18px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 8px 22px rgba(10, 163, 166, 0.25);
    }

    .topbar h1 {
      font-family: "Space Grotesk", "Trebuchet MS", sans-serif;
      font-size: 22px;
      margin: 0;
      letter-spacing: 0.5px;
    }

    .topbar .badge {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.35);
      font-weight: 500;
      padding: 6px 12px;
    }

    .page {
      padding: 24px 24px 40px;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.is-active {
      display: block;
    }

    .hero {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 10px;
    }

    .hero h2 {
      font-family: "Space Grotesk", "Trebuchet MS", sans-serif;
      font-size: 28px;
      margin: 0;
    }

    .search-box {
      display: flex;
      gap: 10px;
      flex-wrap: nowrap;
      align-items: center;
      flex: 1 1 50%;
      max-width: 50%;
    }

    .search-box input {
      flex: 1 1 auto;
      min-width: 0;
    }

    .search-box .btn {
      white-space: nowrap;
    }

    .search-clear {
      border: 1px solid rgba(15, 23, 42, 0.2);
      background: #ffffff;
      color: var(--ink-700);
      border-radius: 8px;
      padding: 6px 10px;
      font-weight: 600;
    }

    .search-clear.is-hidden {
      display: none;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 14px;
    }

    .stat-card {
      background: var(--card);
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(15, 23, 42, 0.06);
    }

    .stat-card h3 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1.1px;
      color: var(--ink-500);
      margin: 0 0 6px;
    }

    .stat-card p {
      font-family: "Space Grotesk", "Trebuchet MS", sans-serif;
      font-size: 20px;
      margin: 0;
    }

    .stat-card small {
      display: block;
      font-size: 12px;
      color: var(--ink-500);
      margin-top: 4px;
    }

    .lead-list {
      display: grid;
      gap: 14px;
    }

    .lead-card {
      background: var(--card);
      border-radius: 16px;
      padding: 12px 16px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(15, 23, 42, 0.06);
      display: grid;
      gap: 12px;
      animation: fadeUp 0.6s ease both;
      animation-delay: calc(var(--i, 0) * 40ms);
    }

    .lead-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .lead-row-main {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: var(--ink-700);
    }

    .lead-row-main .lead-id {
      font-family: "Space Grotesk", "Trebuchet MS", sans-serif;
      font-size: 15px;
      color: var(--ink-900);
    }

    .lead-row-actions {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    .lead-status {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: var(--ink-500);
    }

    .lead-status label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .level-stars {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .level-star {
      border: 1px solid rgba(15, 23, 42, 0.2);
      border-radius: 10px;
      width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      background: #ffffff;
    }

    .level-star svg {
      width: 15px;
      height: 15px;
      fill: #cbd5e1;
    }

    .level-star.is-selected {
      border-color: var(--accent);
      background: rgba(10, 163, 166, 0.12);
    }

    .level-star.is-selected svg {
      fill: var(--accent);
    }

    .level-star.is-selected.is-first {
      border-color: #f5b301;
      background: rgba(245, 179, 1, 0.15);
    }

    .level-star.is-selected.is-first svg {
      fill: #f5b301;
    }

    .lead-details {
      display: none;
    }

    .lead-card.is-expanded .lead-details {
      display: block;
    }

    .lead-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px 16px;
    }

    .lead-block {
      background: #f6f8f9;
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid rgba(12, 74, 110, 0.08);
    }

    .lead-block .label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: var(--ink-500);
      margin-bottom: 6px;
    }

    .lead-block .value {
      font-size: 14px;
      color: var(--ink-900);
      font-weight: 500;
      word-break: break-word;
    }

    .lead-meta {
      display: grid;
      gap: 6px;
      font-size: 12px;
      color: var(--ink-500);
    }

    .lead-meta .value {
      color: var(--ink-900);
      font-weight: 500;
    }

    .select-user {
      display: grid;
      gap: 8px;
      align-items: center;
    }

    .select-user select {
      font-size: 13px;
    }

    .password-display,
    .username-display {
      font-size: 12px;
      margin: 0;
      min-height: 14px;
    }

    .password-display {
      color: #c0392b;
    }

    .username-display {
      color: var(--ink-700);
    }

    .pagination {
      margin: 12px 0 18px;
    }

    .detail-meta {
      display: grid;
      gap: 6px;
      font-size: 13px;
      color: var(--ink-500);
    }

    .detail-meta strong {
      color: var(--ink-900);
      font-weight: 600;
    }

    .detail-meta .big-number {
      font-family: "Space Grotesk", "Trebuchet MS", sans-serif;
      font-size: 20px;
      color: var(--ink-900);
    }

    .detail-images {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 10px;
    }

    .detail-images a {
      display: inline-flex;
    }

    .detail-images img {
      width: 100%;
      height: 84px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: #ffffff;
    }

    .detail-gallery-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
      font-size: 12px;
      color: var(--ink-500);
      width: 100%;
    }

    .detail-gallery-controls nav {
      flex: 1 1 auto;
    }

    .detail-gallery-controls .pagination {
      justify-content: center;
      flex-wrap: wrap;
      width: 100%;
    }

    .gallery-arrow {
      font-size: 18px;
      font-weight: 700;
      line-height: 1;
    }

    .toggle-icon {
      display: inline-flex;
      width: 16px;
      height: 16px;
      line-height: 1;
    }

    .lead-card.is-expanded .toggle-icon {
      transform: rotate(180deg);
    }

    .toggle-icon svg {
      width: 100%;
      height: 100%;
      stroke: #111111;
      stroke-width: 3.2;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }

    .landing-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      margin-bottom: 6px;
    }

    .landing-header h2 {
      font-family: "Space Grotesk", "Trebuchet MS", sans-serif;
      margin: 0;
      font-size: 24px;
      text-transform: capitalize;
    }

    .landing-controls {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .landing-controls select {
      border-radius: 10px;
      border: 1px solid rgba(15, 23, 42, 0.2);
      padding: 6px 10px;
      font-size: 13px;
    }

    .landing-save-status {
      font-size: 12px;
      color: var(--ink-500);
      margin-bottom: 4px;
      min-height: 16px;
    }

    .landing-save-status.is-success {
      color: var(--accent-deep);
    }

    .landing-save-status.is-error {
      color: #c0392b;
    }

    .landing-editor {
      display: grid;
      gap: 6px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .landing-section {
      background: #ddd;
      border-radius: 14px;
      padding: 12px;
      border: 1px solid rgba(15, 23, 42, 0.14);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
      grid-column: span 2;
    }

    .landing-section[data-section="pricing"] {
      grid-column: span 1;
    }

    .landing-section[data-section="categories"] {
      grid-column: 1 / -1;
    }

    .landing-section[data-section="hero"] {
      grid-column: 1 / -1;
    }

    .landing-section[data-section="pricing"],
    .landing-section[data-section="pricing-image"] {
      grid-column: span 1;
    }

    .landing-section[data-section="categories"] .landing-fields {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    .landing-section[data-section="categories"] .landing-array-item .landing-fields {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    .landing-section[data-section="reasons"] .landing-fields {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .landing-section[data-section="footer"] .landing-fields {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .landing-section-title {
      font-family: "Space Grotesk", "Trebuchet MS", sans-serif;
      font-size: 16px;
      margin: 0 0 4px;
      text-transform: capitalize;
    }

    .landing-fields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 3px;
    }

    .landing-block {
      grid-column: 1 / -1;
      background: #f1ede4;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(12, 74, 110, 0.12);
      display: grid;
      gap: 3px;
    }

    .landing-section[data-section="hero"] .landing-fields,
    .landing-section[data-section="categories"] .landing-fields {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .landing-block-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--ink-700);
      text-transform: capitalize;
    }

    .landing-array-item {
      background: #ffffff;
      border-radius: 10px;
      padding: 10px;
      border: 1px solid rgba(12, 74, 110, 0.12);
      display: grid;
      gap: 3px;
    }

    .landing-array-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .landing-array-actions .btn {
      padding: 2px 8px;
    }

    .landing-array-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
    }

    .landing-array-grid > .landing-block-title {
      grid-column: 1 / -1;
    }

    .landing-array-grid > .landing-array-actions {
      grid-column: 1 / -1;
    }

    .landing-array-grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
    }

    .landing-array-grid-2 > .landing-block-title {
      grid-column: 1 / -1;
    }

    .landing-array-grid-2 > .landing-array-actions {
      grid-column: 1 / -1;
    }

    .landing-item-title {
      font-size: 12px;
      color: var(--ink-500);
      text-transform: capitalize;
    }

    .landing-field {
      display: grid;
      gap: 2px;
    }

    .landing-field.is-checkbox {
      grid-template-columns: auto 1fr;
      align-items: center;
    }

    .landing-field.is-full {
      grid-column: 1 / -1;
    }

    .landing-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--ink-700);
      text-transform: capitalize;
    }

    .landing-path {
      font-size: 11px;
      color: var(--ink-500);
    }

    .landing-input input,
    .landing-input textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(15, 23, 42, 0.2);
      padding: 8px 10px;
      font-size: 13px;
    }

    .landing-input textarea {
      min-height: 72px;
      resize: vertical;
    }

    @media (min-width: 1400px) {
      .landing-editor {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .landing-section {
        grid-column: span 3;
      }

      .landing-section[data-section="pricing"] {
        grid-column: span 1;
      }

      .landing-section[data-section="categories"] {
        grid-column: 1 / -1;
      }

      .landing-section[data-section="hero"] {
        grid-column: 1 / -1;
      }

      .landing-section[data-section="pricing"],
      .landing-section[data-section="pricing-image"] {
        grid-column: span 1;
      }
    }

    .landing-upload-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 3px;
    }

    .landing-upload-status {
      font-size: 12px;
      color: var(--ink-500);
      min-height: 16px;
    }

    .landing-upload-status.is-success {
      color: var(--accent-deep);
    }

    .landing-upload-status.is-error {
      color: #c0392b;
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 720px) {
      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .search-box {
        max-width: 100%;
        flex: 1 1 100%;
      }
    }

    @media (max-width: 960px) {
      .shell {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: auto;
        position: static;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }

      .sidebar-nav {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <aside class="sidebar">
      <div class="sidebar-brand">
        <span class="sidebar-dot"></span>
        <div>
          <div class="sidebar-title">ADMAKE</div>
          <div class="sidebar-subtitle">Admin Console</div>
        </div>
      </div>
      <div class="sidebar-nav">
        <button class="sidebar-link is-active" type="button" data-tab-target="leadManageTab">Lead manage</button>
        <button class="sidebar-link" type="button" data-tab-target="landingPageTab">Landing page</button>
      </div>
    </aside>

    <div class="content">
      <header class="topbar">
        <h1>{{ labels.header_title or "ADMAKE Lead Management" }}</h1>
        <span class="badge">{{ labels.header_badge or "Admin View" }}</span>
      </header>

      <main class="page">
        <section class="tab-panel is-active" id="leadManageTab">
          <section class="hero">
            <div>
              <h2>{{ labels.hero_title or "Lead Overview" }}</h2>
              <p class="text-muted mb-0">{{ labels.hero_subtitle or "Compact rows with expand-on-demand details." }}</p>
            </div>
            <form class="search-box" method="get" style="flex-wrap: nowrap;">
              <input class="form-control" type="text" name="q" id="leadSearchInput" value="{{ query_text }}"
                     placeholder="{{ labels.search_placeholder or "Search by lead name, company, or mobile" }}" />
              <button class="search-clear {% if not query_text %}is-hidden{% endif %}" type="button" id="leadSearchClear">x</button>
              <button class="btn btn-primary btn-sm" type="submit">{{ labels.search_button or "Search" }}</button>
            </form>
          </section>

          <section class="stats">
            <div class="stat-card">
              <h3>{{ labels.stats_total_leads or "Total Leads" }}</h3>
              <p data-count="{{ totals.leads }}">0</p>
            </div>
            <div class="stat-card">
              <h3>{{ labels.stats_assignable_customers or "Assignable + Customers" }}</h3>
              <p data-count="{{ total_users_all }}">0</p>
              <small>{{ labels.stats_customers_label or "Customers" }}: <span data-count="{{ totals.customers }}">0</span></small>
            </div>
            <div class="stat-card">
              <h3>{{ labels.stats_workspaces_tasks or "Workspaces + Tasks" }}</h3>
              <p data-count="{{ totals.workspaces }}">0</p>
              <small>{{ labels.stats_tasks_label or "Tasks" }}: <span data-count="{{ totals.tasks }}">0</span></small>
            </div>
            <div class="stat-card">
              <h3>{{ labels.stats_messages or "Messages" }}</h3>
              <p data-count="{{ totals.messages }}">0</p>
            </div>
            <div class="stat-card">
              <h3>{{ labels.stats_workpoints or "Workpoints" }}</h3>
              <p data-count="{{ totals.workpoints }}">0</p>
            </div>
            <div class="stat-card">
              <h3>{{ labels.stats_leaves or "Leaves" }}</h3>
              <p data-count="{{ totals.leaves }}">0</p>
            </div>
          </section>

          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
              {% if page > 1 %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page - 1 }}&q={{ query_text }}" aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              {% endif %}

              {% for p in range(1, total_pages + 1) %}
              <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}&q={{ query_text }}">{{ p }}</a>
              </li>
              {% endfor %}

              {% if page < total_pages %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page + 1 }}&q={{ query_text }}" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
              {% endif %}
            </ul>
          </nav>

          <section class="lead-list">
            {% for lead in leads %}
            <article class="lead-card" data-lead-id="{{ lead.id }}" style="--i: {{ loop.index0 }};">
              <div class="lead-row">
                <div class="lead-row-main">
                  <span class="lead-id">{{ labels.lead_prefix or "Lead" }} #{{ lead.id }}</span>
                  <span>{{ lead.company or 'N/A' }}</span>
                  <span>{{ lead.phone or 'N/A' }}</span>
                  <span>{{ lead.email or 'N/A' }}</span>
                </div>
                <div class="lead-row-actions">
                  <div class="lead-status">
                    <label>
                      <input type="checkbox" name="selected_leads" value="{{ lead.id }}" {% if lead.isInvited %}checked{% endif %} />
                      {{ labels.status_invited or "Invited" }}
                    </label>
                    <label>
                      <input type="checkbox" name="activated_leads" value="{{ lead.id }}" {% if lead.isActivated %}checked{% endif %} />
                      {{ labels.status_active or "Active" }}
                    </label>
                  </div>
                  <div class="level-control" data-lead-id="{{ lead.id }}" data-level="{{ lead.level or 0 }}">
                    <div class="level-stars">
                      {% for lvl in range(0, 4) %}
                      <button type="button" class="level-star {% if lvl == 0 %}is-first{% endif %} {% if (lead.level or 0) == lvl %}is-selected{% endif %}"
                              data-level="{{ lvl }}" aria-label="Level {{ lvl }}">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M12 2.6l2.6 5.3 5.9.9-4.3 4.2 1 5.9-5.2-2.8-5.2 2.8 1-5.9-4.3-4.2 5.9-.9L12 2.6z" />
                        </svg>
                      </button>
                      {% endfor %}
                    </div>
                  </div>
                  <button class="btn btn-sm btn-outline-secondary toggle-details" type="button" aria-label="Toggle details">
                    <span class="toggle-icon" aria-hidden="true">
                      <svg viewBox="0 0 24 24" role="img">
                        <path d="M4 8 L12 16 L20 8" />
                      </svg>
                    </span>
                  </button>
                  <button class="btn btn-sm btn-outline-dark detail-btn" type="button"
                          data-lead-id="{{ lead.id }}"
                          data-lead-name="{{ lead.name or 'N/A' }}"
                          data-company="{{ lead.company or 'N/A' }}"
                          data-stats='{{ lead.stats | tojson }}'>
                    {{ labels.button_details or "Details" }}
                  </button>
                </div>
              </div>

              <div class="lead-details">
                <div class="lead-grid">
                  <div class="lead-block">
                    <div class="label">{{ labels.section_lead_name or "Lead Name" }}</div>
                    <div class="value">{{ lead.name or 'N/A' }}</div>
                  </div>
                  <div class="lead-block select-user">
                    <div class="label">{{ labels.section_assigned_user_customer or "Assigned User + Customer" }}</div>
                    <select class="form-select form-select-sm" name="status-{{ lead.id }}"
                            id="select-{{ lead.id }}" data-lead-id="{{ lead.id }}">
                      <option value="">{{ labels.select_user_placeholder or "-- Select user --" }}</option>
                      {% for user in users %}
                      <option value="{{ user.id }}"
                              data-username="{{ user.username }}"
                              data-password="{{ user.password }}"
                              {% if user.id|string == lead.user_id_str %}selected{% endif %}>
                        {{ user.username }}
                      </option>
                      {% endfor %}
                    </select>
                    <p id="username-display-{{ lead.id }}" class="username-display"></p>
                    <p id="password-display-{{ lead.id }}" class="password-display"></p>
                    <div class="lead-meta">{{ labels.label_customers or "Customers" }}: <span class="value">{{ lead.stats.customers }}</span></div>
                  </div>
                  <div class="lead-block">
                    <div class="label">{{ labels.section_company or "Company" }}</div>
                    <div class="value">{{ lead.company or 'N/A' }}</div>
                    <div class="lead-meta">{{ labels.label_company_size or "Size" }}: <span class="value">{{ lead.companySize or 'N/A' }}</span></div>
                  </div>
                  <div class="lead-block">
                    <div class="label">{{ labels.section_contact or "Contact" }}</div>
                    <div class="value">{{ lead.phone or 'N/A' }}</div>
                    <div class="lead-meta">{{ labels.label_email or "Email" }}: <span class="value">{{ lead.email or 'N/A' }}</span></div>
                  </div>
                  <div class="lead-block">
                    <div class="label">{{ labels.section_workspaces_tasks or "Workspaces + Tasks" }}</div>
                    <div class="lead-meta">{{ labels.label_workspaces or "Workspaces" }}: <span class="value">{{ lead.stats.workspaces }}</span></div>
                    <div class="lead-meta">{{ labels.label_tasks or "Tasks" }}: <span class="value">{{ lead.stats.tasks }}</span></div>
                  </div>
                  <div class="lead-block">
                    <div class="label">{{ labels.section_activity or "Activity" }}</div>
                    <div class="lead-meta">{{ labels.label_messages or "Messages" }}: <span class="value">{{ lead.stats.messages }}</span></div>
                    <div class="lead-meta">{{ labels.label_workpoints or "Workpoints" }}: <span class="value">{{ lead.stats.workpoints }}</span></div>
                    <div class="lead-meta">{{ labels.label_leaves or "Leaves" }}: <span class="value">{{ lead.stats.leaves }}</span></div>
                  </div>
                  <div class="lead-block">
                    <div class="label">{{ labels.section_balance or "Balance" }}</div>
                    <div class="value">{{ lead.balance_amount or '0' }}</div>
                  </div>
                  <div class="lead-block">
                    <div class="label">{{ labels.section_dates or "Dates" }}</div>
                    <div class="lead-meta">{{ labels.label_created or "Created" }}: <span class="value">{{ lead.createdAt }}</span></div>
                    <div class="lead-meta">{{ labels.label_updated or "Updated" }}: <span class="value">{{ lead.updatedAt }}</span></div>
                    <div class="lead-meta">{{ labels.label_expires or "Expires" }}: <span class="value" style="color: #c0392b;">{{ lead.expiredAt }}</span></div>
                  </div>
                </div>
              </div>
            </article>
            {% endfor %}
          </section>
        </section>

        <section class="tab-panel" id="landingPageTab">
          <div class="landing-header">
            <div>
              <h2>Landing page content</h2>
              <p class="text-muted mb-0">Edit sections and save to content.json.</p>
            </div>
            <div class="landing-controls">
              <select id="landingLangSelect" aria-label="Language">
                <option value="vi">Vietnamese</option>
                <option value="en">English</option>
                <option value="zh">Chinese</option>
              </select>
              <button class="btn btn-primary btn-sm" type="button" id="landingSaveBtn">Save</button>
            </div>
          </div>
          <div class="landing-save-status" id="landingSaveStatus"></div>
          <div class="landing-editor" id="landingContentEditor"></div>
        </section>
      </main>
    </div>
  </div>

  <div class="modal fade" id="leadDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ labels.modal_title or "Lead Details" }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="detail-meta mb-3">
            <div>{{ labels.modal_lead or "Lead" }}: <strong id="detailLeadName">N/A</strong></div>
            <div>{{ labels.modal_company or "Company" }}: <strong id="detailLeadCompany">N/A</strong></div>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="lead-block">
                <div class="label">{{ labels.modal_user_counts or "User Counts" }}</div>
                <div class="detail-meta">
                  <div class="big-number" id="detailUsersTotal">0</div>
                  <div>{{ labels.modal_total_users or "Total Users" }}</div>
                  <div>{{ labels.modal_staff_users or "Staff Users" }}: <strong id="detailUsersStaff">0</strong></div>
                  <div>{{ labels.modal_customer_role or "Customer Role" }}: <strong id="detailUsersCustomerRole">0</strong></div>
                  <div>{{ labels.modal_customer_table or "Customer Table" }}: <strong id="detailCustomers">0</strong></div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="lead-block">
                <div class="label">{{ labels.modal_lead_records or "Lead Records" }}</div>
                <div class="detail-meta">
                  <div class="big-number" id="detailWorkspaces">0</div>
                  <div>{{ labels.label_workspaces or "Workspaces" }}</div>
                  <div>{{ labels.label_tasks or "Tasks" }}: <strong id="detailTasks">0</strong></div>
                  <div>{{ labels.label_messages or "Messages" }}: <strong id="detailMessages">0</strong></div>
                  <div>{{ labels.label_workpoints or "Workpoints" }}: <strong id="detailWorkpoints">0</strong></div>
                  <div>{{ labels.label_leaves or "Leaves" }}: <strong id="detailLeaves">0</strong></div>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="lead-block">
                <div class="label">{{ labels.modal_last_activity or "Last Activity" }}</div>
                <div class="detail-meta">
                  <div>{{ labels.modal_last_message or "Last Chat Message" }}: <strong id="detailLastMessage">N/A</strong></div>
                  <div>{{ labels.modal_last_workspace or "Last Workspace Update" }}: <strong id="detailLastWorkspace">N/A</strong></div>
                  <div>{{ labels.modal_last_task or "Last Task Update" }}: <strong id="detailLastTask">N/A</strong></div>
                  <div>{{ labels.modal_last_user or "Last User Update" }}: <strong id="detailLastUser">N/A</strong></div>
                  <div>{{ labels.modal_last_workpoint or "Last Workpoint Update" }}: <strong id="detailLastWorkpoint">N/A</strong></div>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="lead-block">
                <div class="label">{{ labels.modal_asset_images or "Recent Assets" }}</div>
                <div class="detail-images" id="detailAssetImages"></div>
                <div class="detail-gallery-controls">
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="detailGalleryPrev" aria-label="Previous">
                    <span class="gallery-arrow" aria-hidden="true">←</span>
                  </button>
                  <nav aria-label="Gallery pagination">
                    <ul class="pagination pagination-sm mb-0" id="detailGalleryPager"></ul>
                  </nav>
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="detailGalleryNext" aria-label="Next">
                    <span class="gallery-arrow" aria-hidden="true">→</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ labels.modal_close or "Close" }}</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const tabButtons = document.querySelectorAll('.sidebar-link');
      const tabPanels = document.querySelectorAll('.tab-panel');

      const setActiveTab = (targetId) => {
        tabPanels.forEach(panel => {
          panel.classList.toggle('is-active', panel.id === targetId);
        });
        tabButtons.forEach(btn => {
          btn.classList.toggle('is-active', btn.dataset.tabTarget === targetId);
        });
      };

      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          setActiveTab(btn.dataset.tabTarget);
        });
      });

      const landingEditor = document.getElementById('landingContentEditor');
      const landingSaveBtn = document.getElementById('landingSaveBtn');
      const landingLangSelect = document.getElementById('landingLangSelect');
      const landingSaveStatus = document.getElementById('landingSaveStatus');

      const LANGS = ['vi', 'en', 'zh'];
      const IMAGE_FIELD_KEYS = ['image', 'backgroundImage', 'logo', 'wordmark', 'icon'];
      let currentLang = landingLangSelect ? landingLangSelect.value : 'vi';
      let landingContent = null;

      const isLangObject = (value) => {
        if (!value || typeof value !== 'object' || Array.isArray(value)) {
          return false;
        }
        const keys = Object.keys(value);
        return keys.length > 0 && keys.every(key => LANGS.includes(key));
      };

      const humanizeLabel = (value) => {
        return String(value || '')
          .replace(/[_-]+/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();
      };

      const shouldSkipKey = (key) => {
        return IMAGE_FIELD_KEYS.includes(key);
      };

      const getPathValue = (obj, path) => {
        return path.reduce((acc, key) => {
          if (acc === null || acc === undefined) {
            return undefined;
          }
          return acc[key];
        }, obj);
      };

      const setPathValue = (obj, path, value) => {
        let ref = obj;
        for (let i = 0; i < path.length - 1; i += 1) {
          if (ref === null || ref === undefined) {
            return;
          }
          ref = ref[path[i]];
        }
        if (ref === null || ref === undefined) {
          return;
        }
        ref[path[path.length - 1]] = value;
      };

      const setSaveStatus = (message, tone) => {
        if (!landingSaveStatus) return;
        landingSaveStatus.textContent = message;
        landingSaveStatus.className = 'landing-save-status' + (tone ? ` is-${tone}` : '');
      };

      const getPricingElements = () => {
        return {
          pricingImagePath: document.getElementById('pricingImagePath'),
          pricingImageFile: document.getElementById('pricingImageFile'),
          pricingImageUploadBtn: document.getElementById('pricingImageUploadBtn'),
          pricingImageStatus: document.getElementById('pricingImageStatus'),
        };
      };

      const createPricingUploadSection = () => {
        const section = document.createElement('div');
        section.className = 'landing-section';
        section.dataset.section = 'pricing-image';

        const title = document.createElement('div');
        title.className = 'landing-section-title';
        title.textContent = 'Pricing image';
        section.appendChild(title);

        const fields = document.createElement('div');
        fields.className = 'landing-fields';

        const field = document.createElement('div');
        field.className = 'landing-field';

        const label = document.createElement('div');
        label.className = 'landing-label';
        label.textContent = 'File';

        const path = document.createElement('div');
        path.className = 'landing-path';
        path.id = 'pricingImagePath';
        path.textContent = 'pricing.image';

        const inputWrap = document.createElement('div');
        inputWrap.className = 'landing-input landing-upload-row';

        const input = document.createElement('input');
        input.type = 'file';
        input.id = 'pricingImageFile';
        input.accept = 'image/*';

        const button = document.createElement('button');
        button.type = 'button';
        button.id = 'pricingImageUploadBtn';
        button.className = 'btn btn-outline-dark btn-sm';
        button.textContent = 'Upload (Replace)';

        inputWrap.appendChild(input);
        inputWrap.appendChild(button);

        const status = document.createElement('div');
        status.className = 'landing-upload-status';
        status.id = 'pricingImageStatus';

        field.appendChild(label);
        field.appendChild(path);
        field.appendChild(inputWrap);
        field.appendChild(status);
        fields.appendChild(field);
        section.appendChild(fields);
        return section;
      };

      const createField = ({
        label,
        path,
        value,
        valueType,
        isLang,
        basePath,
      }) => {
        if (path.length && shouldSkipKey(path[path.length - 1])) {
          return null;
        }
        const field = document.createElement('div');
        field.className = 'landing-field';

        const labelEl = document.createElement('div');
        labelEl.className = 'landing-label';
        labelEl.textContent = label;

        const pathEl = document.createElement('div');
        pathEl.className = 'landing-path';
        pathEl.textContent = path.join('.');

        const inputWrap = document.createElement('div');
        inputWrap.className = 'landing-input';

        let input;
        const stringValue = value === null || value === undefined ? '' : String(value);
        const useTextarea = valueType === 'string' && (stringValue.length > 80 || stringValue.includes('\n') || stringValue.includes('<'));

        if (valueType === 'boolean') {
          input = document.createElement('input');
          input.type = 'checkbox';
          input.checked = Boolean(value);
          field.classList.add('is-checkbox');
        } else if (useTextarea) {
          input = document.createElement('textarea');
          input.value = stringValue;
        } else {
          input = document.createElement('input');
          input.type = valueType === 'number' ? 'number' : 'text';
          input.value = stringValue;
        }

        if (isLang) {
          input.dataset.langBase = JSON.stringify(basePath);
        } else {
          input.dataset.path = JSON.stringify(path);
        }

        const updateValue = (rawValue) => {
          if (!landingContent) return;
          let nextValue = rawValue;
          if (valueType === 'number') {
            nextValue = rawValue === '' ? '' : Number(rawValue);
          }
          if (valueType === 'boolean') {
            nextValue = Boolean(rawValue);
          }
          if (isLang) {
            setPathValue(landingContent, basePath.concat([currentLang]), nextValue);
          } else {
            setPathValue(landingContent, path, nextValue);
          }
        };

        const handler = () => {
          if (valueType === 'boolean') {
            updateValue(input.checked);
          } else {
            updateValue(input.value);
          }
        };

        input.addEventListener(valueType === 'boolean' ? 'change' : 'input', handler);

        inputWrap.appendChild(input);
        field.appendChild(labelEl);
        field.appendChild(pathEl);
        field.appendChild(inputWrap);
        return field;
      };

      const isEmptyContentValue = (contentValue) => {
        if (contentValue === null || contentValue === undefined) {
          return true;
        }
        if (typeof contentValue === 'string') {
          return contentValue.trim() === '';
        }
        return false;
      };

      const cloneForCategory = (template) => {
        const next = JSON.parse(JSON.stringify(template || {}));
        const clearLang = (obj) => {
          if (!obj || typeof obj !== 'object') return;
          if (isLangObject(obj)) {
            LANGS.forEach(lang => {
              obj[lang] = '';
            });
            return;
          }
          Object.values(obj).forEach(child => clearLang(child));
        };
        clearLang(next);
        if (next.content !== undefined && typeof next.content === 'string') {
          next.content = '';
        }
        return next;
      };

      const renderNode = (container, key, value, path, depth) => {
        if (shouldSkipKey(key)) {
          return;
        }
        if (key === 'content') {
          if (isLangObject(value)) {
            const langValue = value[currentLang] ?? '';
            if (isEmptyContentValue(langValue)) {
              return;
            }
          } else if (isEmptyContentValue(value)) {
            return;
          }
        }
        if (isLangObject(value)) {
          const langValue = value[currentLang] ?? '';
          const field = createField({
            label: humanizeLabel(key),
            path,
            value: langValue,
            valueType: 'string',
            isLang: true,
            basePath: path,
          });
          if (field) {
            container.appendChild(field);
          }
          return;
        }

        if (Array.isArray(value)) {
          const block = document.createElement('div');
          block.className = 'landing-block';
          const title = document.createElement('div');
          title.className = 'landing-block-title';
          title.textContent = humanizeLabel(key);
          block.appendChild(title);
          const pathKey = path.join('.');
          if (pathKey === 'categories.items') {
            block.classList.add('landing-array-grid');
          }
          if (pathKey.startsWith('reasons.columns.') && pathKey.endsWith('.items')) {
            block.classList.add('landing-array-grid-2');
          }

          value.forEach((item, index) => {
            const itemWrap = document.createElement('div');
            itemWrap.className = 'landing-array-item';
            const itemTitle = document.createElement('div');
            itemTitle.className = 'landing-item-title';
            let itemLabel = `Item ${index + 1}`;
            if (item && typeof item === 'object') {
              if (item.id) {
                itemLabel += ` - ${item.id}`;
              } else if (item.name) {
                itemLabel += ` - ${item.name}`;
              }
            }
            if (pathKey === 'categories.items') {
              const actions = document.createElement('div');
              actions.className = 'landing-array-actions';
              itemTitle.textContent = itemLabel;
              const removeBtn = document.createElement('button');
              removeBtn.type = 'button';
              removeBtn.className = 'btn btn-outline-danger btn-sm';
              removeBtn.textContent = 'Remove';
              removeBtn.addEventListener('click', () => {
                if (!landingContent?.categories?.items) return;
                landingContent.categories.items.splice(index, 1);
                renderLandingEditor();
              });
              actions.appendChild(itemTitle);
              actions.appendChild(removeBtn);
              itemWrap.appendChild(actions);
            } else {
              itemTitle.textContent = itemLabel;
              itemWrap.appendChild(itemTitle);
            }
            const itemFields = document.createElement('div');
            itemFields.className = 'landing-fields';
            if (item && typeof item === 'object' && !Array.isArray(item)) {
              Object.entries(item).forEach(([childKey, childValue]) => {
                renderNode(itemFields, childKey, childValue, path.concat([index, childKey]), depth + 1);
              });
            } else {
              renderNode(itemFields, key, item, path.concat([index]), depth + 1);
            }
            itemWrap.appendChild(itemFields);
            block.appendChild(itemWrap);
          });

          if (pathKey === 'categories.items') {
            const addWrap = document.createElement('div');
            addWrap.className = 'landing-array-actions';
            const addLabel = document.createElement('div');
            addLabel.className = 'landing-item-title';
            addLabel.textContent = 'Add new item';
            const addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'btn btn-outline-dark btn-sm';
            addBtn.textContent = 'Add';
            addBtn.addEventListener('click', () => {
              if (!landingContent?.categories) return;
              if (!Array.isArray(landingContent.categories.items)) {
                landingContent.categories.items = [];
              }
              const template = landingContent.categories.items[landingContent.categories.items.length - 1] || {};
              landingContent.categories.items.push(cloneForCategory(template));
              renderLandingEditor();
            });
            addWrap.appendChild(addLabel);
            addWrap.appendChild(addBtn);
            block.appendChild(addWrap);
          }

          container.appendChild(block);
          return;
        }

        if (value && typeof value === 'object') {
          const block = document.createElement('div');
          block.className = 'landing-block';
          const title = document.createElement('div');
          title.className = 'landing-block-title';
          title.textContent = humanizeLabel(key);
          block.appendChild(title);
          const fields = document.createElement('div');
          fields.className = 'landing-fields';
          Object.entries(value).forEach(([childKey, childValue]) => {
            renderNode(fields, childKey, childValue, path.concat([childKey]), depth + 1);
          });
          block.appendChild(fields);
          container.appendChild(block);
          return;
        }

        const valueType = typeof value === 'number' ? 'number' : typeof value === 'boolean' ? 'boolean' : 'string';
        const field = createField({
          label: humanizeLabel(key),
          path,
          value,
          valueType,
          isLang: false,
        });
        if (field) {
          container.appendChild(field);
        }
      };

      const renderLandingEditor = () => {
        if (!landingEditor || !landingContent) return;
        landingEditor.innerHTML = '';
        Object.entries(landingContent).forEach(([sectionKey, sectionValue]) => {
          if (sectionKey === 'form') {
            return;
          }
          const section = document.createElement('div');
          section.className = 'landing-section';
          section.dataset.section = sectionKey;
          const title = document.createElement('div');
          title.className = 'landing-section-title';
          title.textContent = humanizeLabel(sectionKey);
          section.appendChild(title);
          const fields = document.createElement('div');
          fields.className = 'landing-fields';
          if (sectionValue && typeof sectionValue === 'object' && !Array.isArray(sectionValue)) {
            Object.entries(sectionValue).forEach(([childKey, childValue]) => {
              renderNode(fields, childKey, childValue, [sectionKey, childKey], 0);
            });
          } else {
            renderNode(fields, sectionKey, sectionValue, [sectionKey], 0);
          }
          section.appendChild(fields);
          landingEditor.appendChild(section);
          if (sectionKey === 'pricing') {
            landingEditor.appendChild(createPricingUploadSection());
          }
        });
      };

      const updateLanguageInputs = () => {
        const inputs = document.querySelectorAll('[data-lang-base]');
        inputs.forEach(input => {
          const basePath = JSON.parse(input.dataset.langBase);
          const nextValue = getPathValue(landingContent, basePath.concat([currentLang]));
          const normalized = nextValue === null || nextValue === undefined ? '' : nextValue;
          if (input.tagName === 'TEXTAREA' || input.type === 'text' || input.type === 'number') {
            input.value = String(normalized);
          } else if (input.type === 'checkbox') {
            input.checked = Boolean(normalized);
          }
        });
      };

      const loadLandingContent = () => {
        if (!landingEditor) return;
        landingEditor.textContent = 'Loading...';
        fetch('/api/lead/content/')
          .then(response => {
            if (!response.ok) {
              return response.text().then(text => {
                const detail = text ? text.trim() : response.statusText;
                throw new Error(`HTTP ${response.status}: ${detail}`);
              });
            }
            return response.json();
          })
          .then(data => {
            try {
              landingContent = data;
              renderLandingEditor();
              bindPricingUpload();
              const { pricingImagePath } = getPricingElements();
              if (pricingImagePath) {
                const imageValue = landingContent?.pricing?.image;
                pricingImagePath.textContent = imageValue ? `pricing.image (${imageValue})` : 'pricing.image';
              }
            } catch (error) {
              throw new Error(`Render failed: ${error.message}`);
            }
          })
          .catch((error) => {
            landingEditor.textContent = `Unable to load content. ${error.message}`;
          });
      };

      if (landingLangSelect) {
        landingLangSelect.addEventListener('change', () => {
          currentLang = landingLangSelect.value;
          if (landingContent) {
            updateLanguageInputs();
          }
        });
      }

      if (landingSaveBtn) {
        landingSaveBtn.addEventListener('click', () => {
          if (!landingContent) return;
          setSaveStatus('Saving...', null);
          landingSaveBtn.disabled = true;
          fetch('/api/lead/content/', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(landingContent),
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Save failed');
            }
            return response.json();
          })
          .then(() => {
            setSaveStatus('Saved successfully.', 'success');
          })
          .catch(() => {
            setSaveStatus('Save failed. Please retry.', 'error');
          })
          .finally(() => {
            landingSaveBtn.disabled = false;
          });
        });
      }

      const setPricingImageStatus = (message, tone) => {
        const { pricingImageStatus } = getPricingElements();
        if (!pricingImageStatus) return;
        pricingImageStatus.textContent = message;
        pricingImageStatus.className = 'landing-upload-status' + (tone ? ` is-${tone}` : '');
      };

      const bindPricingUpload = () => {
        const { pricingImageUploadBtn, pricingImageFile } = getPricingElements();
        if (!pricingImageUploadBtn || !pricingImageFile) return;
        pricingImageUploadBtn.addEventListener('click', () => {
          if (!pricingImageFile.files || !pricingImageFile.files[0]) {
            setPricingImageStatus('Choose a file first.', 'error');
            return;
          }
          const file = pricingImageFile.files[0];
          const formData = new FormData();
          formData.append('file', file);
          setPricingImageStatus('Uploading...', null);
          pricingImageUploadBtn.disabled = true;
          fetch('/api/lead/content/pricing-image', {
            method: 'PUT',
            body: formData,
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Upload failed');
            }
            return response.json();
          })
          .then((data) => {
            setPricingImageStatus('Uploaded successfully.', 'success');
            pricingImageFile.value = '';
            const { pricingImagePath } = getPricingElements();
            if (pricingImagePath) {
              const imageValue = data?.path || landingContent?.pricing?.image;
              pricingImagePath.textContent = imageValue ? `pricing.image (${imageValue})` : 'pricing.image';
            }
          })
          .catch(() => {
            setPricingImageStatus('Upload failed. Please retry.', 'error');
          })
          .finally(() => {
            pricingImageUploadBtn.disabled = false;
          });
        });
      };

      loadLandingContent();

      const animatedCounters = document.querySelectorAll('[data-count]');
      animatedCounters.forEach(el => {
        const target = Number(el.dataset.count || 0);
        const duration = 900;
        const start = performance.now();

        function tick(now) {
          const progress = Math.min((now - start) / duration, 1);
          const value = Math.floor(progress * target);
          el.textContent = value.toLocaleString();
          if (progress < 1) {
            requestAnimationFrame(tick);
          } else {
            el.textContent = target.toLocaleString();
          }
        }

        requestAnimationFrame(tick);
      });

      const checkboxes = document.querySelectorAll("input[name='selected_leads']");

      checkboxes.forEach(chk => {
        chk.addEventListener('change', function() {
          const leadId = this.value;

          fetch(`https://admake.vn/api/lead/${leadId}/check`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ isInvited: this.checked })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Update failed');
            }
            return response.json();
          })
          .catch(error => {
            console.error('Update error:', error);
          });
        });
      });

      const activatedCheckboxes = document.querySelectorAll("input[name='activated_leads']");

      activatedCheckboxes.forEach(chk => {
        chk.addEventListener('change', function() {
          const leadId = this.value;

          fetch(`https://admake.vn/api/lead/${leadId}/activate`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ isActivated: this.checked })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Update failed');
            }
            return response.json();
          })
          .catch(error => {
            console.error('Update error:', error);
          });
        });
      });

      const levelControls = document.querySelectorAll('.level-control');

      levelControls.forEach(control => {
        const leadId = control.dataset.leadId;
        const buttons = control.querySelectorAll('.level-star');

        buttons.forEach(button => {
          button.addEventListener('click', function() {
            const level = Number(this.dataset.level);

            fetch(`https://admake.vn/api/lead/${leadId}/level`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ level: level })
            })
            .then(response => {
              if (!response.ok) throw new Error('Update failed');
              return response.json();
            })
            .then(() => {
              buttons.forEach(btn => btn.classList.remove('is-selected'));
              this.classList.add('is-selected');
            })
            .catch(error => {
              console.error('Level update failed:', error);
            });
          });
        });
      });

      const selects = document.querySelectorAll('select[id^="select-"]');

      selects.forEach(function(selectElem) {
        const leadId = selectElem.dataset.leadId;
        const passwordDisplay = document.getElementById('password-display-' + leadId);
        const usernameDisplay = document.getElementById('username-display-' + leadId);

        if (!passwordDisplay || !usernameDisplay) {
          console.warn('Missing display elements for lead:', leadId);
          return;
        }

        if (selectElem.value) {
          const selectedOption = selectElem.options[selectElem.selectedIndex];
          usernameDisplay.textContent = selectedOption.getAttribute('data-username') || '';
          passwordDisplay.textContent = selectedOption.getAttribute('data-password') || '';
        }

        selectElem.addEventListener('change', function() {
          const selectedOption = this.options[this.selectedIndex];
          const userId = selectedOption.value;
          usernameDisplay.textContent = selectedOption.getAttribute('data-username') || '';
          passwordDisplay.textContent = selectedOption.getAttribute('data-password') || '';

          fetch(`https://admake.vn/api/lead/${leadId}/assign-user`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId || null })
          })
          .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
          })
          .catch(error => {
            console.error('Assign user failed:', error);
            this.value = '';
            usernameDisplay.textContent = '';
            passwordDisplay.textContent = '';
          });
        });
      });

      const toggleButtons = document.querySelectorAll('.toggle-details');
      toggleButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          const card = this.closest('.lead-card');
          if (!card) return;
          card.classList.toggle('is-expanded');
        });
      });

      const detailModalEl = document.getElementById('leadDetailModal');
      const detailModal = detailModalEl ? new bootstrap.Modal(detailModalEl) : null;
      const detailButtons = document.querySelectorAll('.detail-btn');

      function formatDate(value) {
        if (!value) return 'N/A';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return value;
        return date.toLocaleString();
      }

      let galleryImages = [];
      let galleryPage = 1;
      const galleryPageSize = 10;
      const galleryPrev = document.getElementById('detailGalleryPrev');
      const galleryNext = document.getElementById('detailGalleryNext');
      const galleryPager = document.getElementById('detailGalleryPager');

      const normalizeUrl = (value) => {
        if (!value) return '';
        if (value.startsWith('http') || value.startsWith('/')) return value;
        return `${window.location.origin}/static/${value}`;
      };

      const buildGalleryPager = (totalPages) => {
        if (!galleryPager) return;
        galleryPager.innerHTML = '';
        const maxVisible = 7;
        const pages = [];
        if (totalPages <= maxVisible) {
          for (let i = 1; i <= totalPages; i += 1) pages.push(i);
        } else {
          pages.push(1);
          const start = Math.max(2, galleryPage - 2);
          const end = Math.min(totalPages - 1, galleryPage + 2);
          if (start > 2) pages.push('...');
          for (let i = start; i <= end; i += 1) pages.push(i);
          if (end < totalPages - 1) pages.push('...');
          pages.push(totalPages);
        }

        pages.forEach((page) => {
          const li = document.createElement('li');
          li.className = 'page-item' + (page === galleryPage ? ' active' : '');
          const link = document.createElement('button');
          link.type = 'button';
          link.className = 'page-link';
          link.textContent = String(page);
          if (page === '...') {
            link.disabled = true;
          } else {
            link.addEventListener('click', () => {
              galleryPage = page;
              renderGallery();
            });
          }
          li.appendChild(link);
          galleryPager.appendChild(li);
        });
      };

      const renderGallery = () => {
        const detailImages = document.getElementById('detailAssetImages');
        if (!detailImages) return;
        detailImages.innerHTML = '';
        const totalPages = Math.max(1, Math.ceil(galleryImages.length / galleryPageSize));
        galleryPage = Math.min(galleryPage, totalPages);
        const start = (galleryPage - 1) * galleryPageSize;
        const end = start + galleryPageSize;
        const slice = galleryImages.slice(start, end);

        if (slice.length === 0) {
          detailImages.textContent = 'N/A';
        } else {
          slice.forEach(entry => {
            const url = normalizeUrl(String(entry || ''));
            if (!url) return;
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            const img = document.createElement('img');
            img.src = url;
            img.alt = 'asset';
            img.onerror = () => {
              link.remove();
            };
            link.appendChild(img);
            detailImages.appendChild(link);
          });
        }

        buildGalleryPager(totalPages);
        if (galleryPrev) {
          galleryPrev.disabled = galleryPage <= 1;
        }
        if (galleryNext) {
          galleryNext.disabled = galleryPage >= totalPages;
        }
      };

      if (galleryPrev) {
        galleryPrev.addEventListener('click', () => {
          if (galleryPage > 1) {
            galleryPage -= 1;
            renderGallery();
          }
        });
      }

      if (galleryNext) {
        galleryNext.addEventListener('click', () => {
          const totalPages = Math.max(1, Math.ceil(galleryImages.length / galleryPageSize));
          if (galleryPage < totalPages) {
            galleryPage += 1;
            renderGallery();
          }
        });
      }

      detailButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          if (!detailModal) return;
          const stats = JSON.parse(this.dataset.stats || '{}');

          document.getElementById('detailLeadName').textContent = this.dataset.leadName || 'N/A';
          document.getElementById('detailLeadCompany').textContent = this.dataset.company || 'N/A';

          document.getElementById('detailUsersTotal').textContent = stats.users_total ?? 0;
          document.getElementById('detailUsersStaff').textContent = stats.users_staff ?? 0;
          document.getElementById('detailUsersCustomerRole').textContent = stats.users_customer_role ?? 0;
          document.getElementById('detailCustomers').textContent = stats.customers ?? 0;

          document.getElementById('detailWorkspaces').textContent = stats.workspaces ?? 0;
          document.getElementById('detailTasks').textContent = stats.tasks ?? 0;
          document.getElementById('detailMessages').textContent = stats.messages ?? 0;
          document.getElementById('detailWorkpoints').textContent = stats.workpoints ?? 0;
          document.getElementById('detailLeaves').textContent = stats.leaves ?? 0;

          document.getElementById('detailLastMessage').textContent = formatDate(stats.last_message_at);
          document.getElementById('detailLastWorkspace').textContent = formatDate(stats.last_workspace_at);
          document.getElementById('detailLastTask').textContent = formatDate(stats.last_task_at);
          document.getElementById('detailLastUser').textContent = formatDate(stats.last_user_at);
          document.getElementById('detailLastWorkpoint').textContent = formatDate(stats.last_workpoint_at);

          galleryImages = Array.isArray(stats.preview_images) ? stats.preview_images : [];
          galleryPage = 1;
          renderGallery();

          detailModal.show();
        });
      });

      const searchInput = document.getElementById('leadSearchInput');
      const clearButton = document.getElementById('leadSearchClear');
      const searchForm = searchInput ? searchInput.closest('form') : null;

      if (searchInput && clearButton && searchForm) {
        const toggleClear = () => {
          clearButton.classList.toggle('is-hidden', !searchInput.value.trim());
        };

        searchInput.addEventListener('input', toggleClear);
        clearButton.addEventListener('click', () => {
          searchInput.value = '';
          toggleClear();
          searchForm.submit();
        });
      }
    });
  </script>
</body>
</html>
